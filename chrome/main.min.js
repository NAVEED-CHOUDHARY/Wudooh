const arabicRegex=new RegExp("([؀-ۿݐ-ݿࢠ-ࣿﭐ-﷿ﹰ-\ufeff]+([؀-ۿݐ-ݿࢠ-ࣿﭐ-﷿ﹰ-\ufeff\\W\\d]+)*)","g"),arabicNumbersRegex=new RegExp("([٠-٩۰-۹]+)","g");let observer;function hasNodeBeenUpdated(e){return e.parentElement&&"true"===e.parentElement.getAttribute("wudooh")}function hasDocumentBeenUpdated(){return null!==document.getElementById("wudoohMetaElement")}function hasArabicScript(e){return!!e.nodeValue&&!!e.nodeValue.match(arabicRegex)}function isNodeEditable(e){const t=e,n=t.nodeName.toLowerCase();return t.isContentEditable||t.nodeType===Node.ELEMENT_NODE&&htmlEditables.contains(n)}function remapNumber(e){const t=e.charAt(0);return"٠"===t||"۰"===t?"0":"١"===t||"۱"===t?"1":"٢"===t||"۲"===t?"2":"٣"===t||"۳"===t?"3":"٤"===t||"۴"===t?"4":"٥"===t||"۵"===t?"5":"٦"===t||"۶"===t?"6":"٧"===t||"۷"===t?"7":"٨"===t||"۸"===t?"8":"٩"===t||"۹"===t?"9":void 0}function getArabicTextNodesIn(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[],o=t.nextNode();for(;o;)hasArabicScript(o)&&n.push(o),o=t.nextNode();return n}async function updateNode(e,t,n,o){let a=t/100,r=n/100;e.nodeValue&&(hasNodeBeenUpdated(e)?updateByChanging(e,a,r,o):hasNodeBeenUpdated(e)||updateByAdding(e,a,r,o))}async function updateByAdding(e,t,n,o){const a=e.parentNode;if(!a||!e)return;if(isNodeEditable(a)||isNodeEditable(e))return;let r;r="Original"===o?"<span wudooh='true' style='font-size:"+t+"em;line-height:"+n+"em;'>$&</span>":"<span wudooh='true' style='font-size:"+t+"em;line-height:"+n+'em;font-family:"'+o+"\";'>$&</span>";let d=e.nodeValue.replace(arabicRegex,r),i=e.nextSibling,s=document.createElement("div");for(s.innerHTML=d;s.firstChild;)a.insertBefore(s.firstChild,i);a.removeChild(e)}async function updateByChanging(e,t,n,o){e.parentElement.style.fontSize=t+"em",e.parentElement.style.lineHeight=n+"em",e.parentElement.style.fontFamily="Original"===o?"":o}async function updateAll(e,t,n){getArabicTextNodesIn(document.body).forEach(o=>updateNode(o,e,t,n))}async function startObserver(e,t,n){if(observer&&(observer.disconnect(),observer=null),!observer){const o={attributes:!1,attributeOldValue:!1,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0};(observer=new MutationObserver(o=>{o.forEach(o=>{o.addedNodes.length>0&&o.addedNodes.forEach(o=>{getArabicTextNodesIn(o).forEach(o=>{updateNode(o,e,t,n)})}),o.target.nodeValue!==o.oldValue&&o.target.parentNode instanceof Node&&getArabicTextNodesIn(o.target.parentNode).forEach(o=>{updateNode(o,e,t,n)})})})).observe(document.body,o)}}async function notifyDocument(){if(!hasDocumentBeenUpdated()){let e=document.createElement("meta");e.id="wudoohMetaElement",e.setAttribute("wudooh","true"),document.head.appendChild(e)}}async function injectCustomFonts(e){let t=get("wudoohCustomFontsStyle");t&&(t.innerHTML="",document.head.removeChild(t),t=null),(t=document.createElement("style")).id="wudoohCustomFontsStyle",e.forEach(e=>{const n=e.fontName,o=e.url;let a=`@font-face { font-family: '${n}'; src: local('${n}')`;o&&(a=a.concat(`, url('${o}')`)),a=a.concat("; }\n"),t.innerHTML=t.innerHTML.concat(a)}),document.head.append(t)}async function toggleOff(){observer.disconnect(),observer=null,getArabicTextNodesIn(document.body).forEach(e=>{e.parentElement.style.fontSize=null,e.parentElement.style.lineHeight=null,e.parentElement.style.fontFamily=null})}async function addMessageListener(){runtime.onMessage.addListener(e=>{null!=e.reason&&(e.reason===reasonUpdateAllText&&main(),e.reason===reasonInjectCustomFonts&&injectCustomFonts(e.customFonts),e.reason===reasonToggleOff&&toggleOff())})}async function main(){const e=await sync.get(keys);let t=e.textSize,n=e.lineHeight,o=e.onOff,a=e.font,r=e.whitelisted,d=e.customSettings,i=e.customFonts,s=new URL(document.URL).hostname,l=!!r.find(e=>e===s),c=d.find(e=>e.url===s);o&&!l&&(injectCustomFonts(i),c&&(t=c.textSize,n=c.lineHeight,a=c.font),updateAll(t,n,a),startObserver(t,n,a),notifyDocument()),hasDocumentBeenUpdated()&&l&&toggleOff()}main(),addMessageListener();