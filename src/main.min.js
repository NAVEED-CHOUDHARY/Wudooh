const arabicRegex=new RegExp("([؀-ۿݐ-ݿࢠ-ࣿﭐ-﷿ﹰ-\ufeff]+([؀-ۿݐ-ݿࢠ-ࣿﭐ-﷿ﹰ-\ufeff\\W\\d]+)*)","g"),arabicNumbersRegex=new RegExp("([٠-٩۰-۹]+)","g"),htmlEditables=["textarea","input","text","email","number","search","tel","url","password"];let observer;function hasNodeBeenUpdated(e){return e.parentElement&&"true"===e.parentElement.getAttribute("wudooh")}function hasDocumentBeenUpdated(){return null!==document.getElementById("wudoohMetaElement")}function hasArabicScript(e){return!!e.nodeValue&&!!e.nodeValue.match(arabicRegex)}function isNodeEditable(e){const t=e,n=t.nodeName.toLowerCase();return t.isContentEditable||t.nodeType===Node.ELEMENT_NODE&&htmlEditables.contains(n)}function remapNumber(e){const t=e.charAt(0);return"٠"===t||"۰"===t?"0":"١"===t||"۱"===t?"1":"٢"===t||"۲"===t?"2":"٣"===t||"۳"===t?"3":"٤"===t||"۴"===t?"4":"٥"===t||"۵"===t?"5":"٦"===t||"۶"===t?"6":"٧"===t||"۷"===t?"7":"٨"===t||"۸"===t?"8":"٩"===t||"۹"===t?"9":void 0}function getArabicTextNodesIn(e){let t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT),n=[],a=t.nextNode();for(;a;)hasArabicScript(a)&&n.push(a),a=t.nextNode();return n}async function updateNode(e,t,n,a){let o=t/100,r=n/100;e.nodeValue&&(hasNodeBeenUpdated(e)?updateByChanging(e,o,r,a):hasNodeBeenUpdated(e)||updateByAdding(e,o,r,a))}async function updateByAdding(e,t,n,a){const o=e.parentNode;if(!o||!e)return;if(isNodeEditable(o)||isNodeEditable(e))return;let r;r="Original"===a?"<span wudooh='true' style='font-size:"+t+"em;line-height:"+n+"em;'>$&</span>":"<span wudooh='true' style='font-size:"+t+"em;line-height:"+n+'em;font-family:"'+a+"\";'>$&</span>";let d=e.nodeValue.replace(arabicRegex,r),i=e.nextSibling,s=document.createElement("div");for(s.innerHTML=d;s.firstChild;)o.insertBefore(s.firstChild,i);o.removeChild(e)}async function updateByChanging(e,t,n,a){e.parentElement.style.fontSize=t+"em",e.parentElement.style.lineHeight=n+"em",e.parentElement.style.fontFamily="Original"===a?"":a}async function updateAll(e,t,n){getArabicTextNodesIn(document.body).forEach(a=>updateNode(a,e,t,n))}async function startObserver(e,t,n){if(observer&&(observer.disconnect(),observer=null),!observer){const a={attributes:!1,attributeOldValue:!1,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0};(observer=new MutationObserver(a=>{a.forEach(a=>{a.addedNodes.length>0&&a.addedNodes.forEach(a=>{getArabicTextNodesIn(a).forEach(a=>{updateNode(a,e,t,n)})}),a.target.nodeValue!==a.oldValue&&a.target.parentNode instanceof Node&&getArabicTextNodesIn(a.target.parentNode).forEach(a=>{updateNode(a,e,t,n)})})})).observe(document.body,a)}}async function notifyDocument(){if(!hasDocumentBeenUpdated()){let e=document.createElement("meta");e.id="wudoohMetaElement",e.setAttribute("wudooh","true"),document.head.appendChild(e)}}async function toggleOff(){observer&&(observer.disconnect(),observer=null),getArabicTextNodesIn(document.body).forEach(e=>{e.parentElement.style.fontSize=null,e.parentElement.style.lineHeight=null,e.parentElement.style.fontFamily=null})}async function addMessageListener(){runtime.onMessage.addListener(e=>{null!=e.reason&&(e.reason===reasonUpdateAllText&&main(),e.reason===reasonInjectCustomFonts&&injectCustomFonts(e.customFonts),e.reason===reasonToggleOff&&toggleOff())})}async function main(){const e=await sync.get(keys);let t=e.textSize,n=e.lineHeight,a=e.font;const o=e.onOff,r=e.whitelisted,d=e.customSettings,i=e.customFonts,s=new URL(document.URL).hostname,l=!!r.find(e=>e===s),u=d.find(e=>e.url===s);o&&!l&&(injectCustomFonts(i),u&&(t=u.textSize,n=u.lineHeight,a=u.font),updateAll(t,n,a),startObserver(t,n,a),notifyDocument()),hasDocumentBeenUpdated()&&l&&toggleOff()}main(),addMessageListener();